# Ansible Role: WireGuard

This role installs and configures WireGuard as a VPN server.

## Supported Operating Systems

This role has been tested and supports the following operating systems:

* Debian
* FreeBSD
* macOS (Darwin)
* OpenBSD

## Role Variables

### Mandatory Variables

* `wireguard`: A dictionary containing WireGuard interface and peer
  configuration.
  * `address`: (String) The IP address and subnet for the WireGuard
     server's interface (e.g., "10.0.0.1/24").

### Optional Variables

* `wireguard.listen_port`: (Integer) The port WireGuard will listen on.
  Defaults to `51820`.
  * `wireguard.peers`: (List of Dictionaries) A list of peers to
    configure.  Each dictionary *must* contain:
    * `PublicKey`: (String) The public key of the peer.
    You can include other standard WireGuard peer options as key-value
    pairs (e.g., `AllowedIPs: "10.0.0.2/32"`).
* `wireguard.start_at_boot`: (Boolean) Whether to enable and start the
  WireGuard service on boot.  If not defined or `false`, the service
  will be configured but not necessarily started or enabled
  automatically by the generic service task.  Note that OS-specific
  tasks or the macOS launchd configuration might still enable it.
  Defaults to `false` for the generic service handler.
* `wireguard_config_dir`: (String) The directory where WireGuard
  configuration files (`wg0.conf`, `server.key`, `server.pub`) are
  stored.  This is determined automatically based on the OS:
  * FreeBSD: `/usr/local/etc/wireguard`
  * macOS (Darwin): `/opt/homebrew/etc/wireguard`
  * Others: `/etc/wireguard` (default)

## Dependencies

* For macOS, the `community.general.launchd` module is used.  Ensure
  this collection is installed (`ansible-galaxy collection install
  community.general`).
* The role assumes that the necessary WireGuard packages
  (`wireguard-tools` or `wireguard`) can be installed via the system's
  package manager.

## Key Management

The role automatically handles server key generation:

* If `server.key` (private key) doesn't exist in the configuration
  directory, it will be generated automatically
* The corresponding `server.pub` (public key) will also be generated
  from the private key
* Keys are created with appropriate permissions (mode 0600 for private
  key)

## Example Playbook

```yaml
- hosts: servers
  become: yes
  roles:
    - role: wireguard
      vars:
        wireguard:
          address: "10.100.0.1/24"
          listen_port: 51820
          peers:
            - PublicKey: "peer1_public_key_here=="
              AllowedIPs: "10.100.0.2/32"
            - PublicKey: "peer2_public_key_here=="
              AllowedIPs: "10.100.0.3/32"
              # PresharedKey: "peer2_preshared_key_here==" # Example
          start_at_boot: true
```

**Note:** The server's private key is automatically generated by the
role if it doesn't already exist.  You don't need to specify it in your
playbook variables.  The role will create `server.key` and `server.pub`
files in the appropriate configuration directory for your operating
system.

## macOS Specifics

On macOS, WireGuard is managed as a launchd service.  The role will
create/manage a `com.wireguard.wg0.plist` file (expected to be in
`files/com.wireguard.wg0.plist` within the role) and use `launchd` to
control the service.  The `false_for_macos_and_windows` variable is used internally
to manage privilege escalation for Homebrew package installation,
assuming it's set appropriately in your inventory or other var files if
needed (though the role doesn't define a default for it).

## OpenBSD Specifics

On OpenBSD, the role performs additional configuration steps:

* Installs WireGuard using the package `wireguard-tools`.
* Configures OpenBSD's packet filter (pf) by rendering a configuration
  file from the `pf-wg0.conf.j2` template into `/etc/pf-wg0.conf` and
  validating it with `pfctl`.
* Generates the WireGuard configuration file (`wg0.conf`) in the
  directory specified by `wireguard_config_dir`, including settings such
  as the private key, interface address, and listen port.
* Sets `pf` rules via `PostUp` and `PreDown` options to manage the
  interface.
* Enables IPv4 and IPv6 packet forwarding via sysctl.
* If `wireguard.start_at_boot` is enabled, creates the
  `/etc/hostname.wg0` file to ensure the interface is started at boot.
